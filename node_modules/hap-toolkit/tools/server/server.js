"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function asyncGeneratorStep(e,r,t,o,n,s,c){try{var a=e[s](c),i=a.value}catch(e){return void t(e)}a.done?r(i):Promise.resolve(i).then(o,n)}function _asyncToGenerator(e){return function(){var r=this,t=arguments;return new Promise(function(o,n){function s(e){asyncGeneratorStep(a,o,n,s,c,"next",e)}function c(e){asyncGeneratorStep(a,o,n,s,c,"throw",e)}var a=e.apply(r,t);s(void 0)})}}function initServer(e,r){return _initServer.apply(this,arguments)}function _initServer(){return _initServer=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var o,n,s,c,a,i,u,l,p,f,v;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(e.prev=0,o=new _koa.default,o.context.conf=r,n=r.options.clearRecords,n&&(s=r.defaults.pathClientLog,_fs.default.existsSync(s)?(_fs.default.unlinkSync(s),_utils.colorconsole.info("### App Server ### 清空调试设备记录")):_utils.colorconsole.info("### App Server ### 没有需要清空的调试设备记录")),c=0,a=t.moduleList.length;c<a;c++)i=t.moduleList[c],o.use(i.hash.applyRouter(o).routes());u=_http.default.Server(o.callback()),o.server=u,l=0,p=t.moduleList.length;case 9:if(!(l<p)){e.next=17;break}if(f=t.moduleList[l],"function"!=typeof f.hash.beforeStart){e.next=14;break}return e.next=14,f.hash.beforeStart(u,o);case 14:l++,e.next=9;break;case 17:v=r.defaults.serverPort,u.listen(v,function(){var e="http://localhost:".concat(v),r=(0,_utils.getIPv4IPAddress)();if(!r)return void _utils.colorconsole.warn("### App Server ### 本机IP地址为空，无法通过WIFI调试");var t="http://".concat(r,":").concat(v);_utils.colorconsole.info("### App Server ### 服务器地址: ".concat(e,", ").concat(t)),_utils.colorconsole.info("### App Server ### 请确保手机与App Server处于相同网段"),(0,_utils.outputQRCodeOnTerminal)(t)}),o.on("error",function(e,r){_utils.colorconsole.error("### App Server ### 服务器错误: ".concat(e.message));var t="出错了!HTTP error code: ".concat(e.status,", 出错信息: ").concat(e.message);r&&(r.body=t)}),u.on("error",function(e){_utils.colorconsole.error("### App Server ### 服务器错误: ".concat(e.message)),"EADDRINUSE"===e.code&&_utils.colorconsole.error("### App Server ### 服务器错误:端口 ".concat(v," 被占用, 请检查"))}),process.on("SIGINT",function(){_utils.colorconsole.info("### App Server ### SIGINT信号"),_utils.colorconsole.info("### App Server ### 退出server进程 pid: ".concat(process.pid)),process.exit()}),process.on("uncaughtException",function(e){_utils.colorconsole.error("### App Server ### 未定义的异常, 出错信息: ".concat(e.message))}),process.on("message",function(e){e&&e.source&&(o.source=e.source)}),e.next=29;break;case 26:e.prev=26,e.t0=e.catch(0),_utils.colorconsole.error("### App Server ### 服务器启动失败: ".concat(e.t0.message));case 29:case"end":return e.stop()}},e,this,[[0,26]])})),_initServer.apply(this,arguments)}function start(e,r){return _start.apply(this,arguments)}function _start(){return _start=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:initServer(r,t);case 1:case"end":return e.stop()}},e,this)})),_start.apply(this,arguments)}Object.defineProperty(exports,"__esModule",{value:!0}),exports.start=start;var _http=_interopRequireDefault(require("http")),_fs=_interopRequireDefault(require("fs")),_koa=_interopRequireDefault(require("koa")),_utils=require("./lib/utils");