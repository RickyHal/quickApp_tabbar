"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function processImport(e,t,a,s){var r=e,o=e.match(/@import\s+((?:['"]([^()]+?)['"])|(?:(?:url\(([^()]+?)\))))\s*;/g);return o&&o.length>0&&(t?o.forEach(function(e){var o=e.match(/(?:['"]([^()]+?)['"])|(?:(?:url\(([^()]+?)\)))/);if(o.length>1){var i=_path.default.resolve(t,o[1]||o[2]),n=_fs.default.readFileSync(i);if(n){var l=_path.default.dirname(i);r=r.replace(e,"\n"+processImport(n.toString(),l,a,s)+"\n"),s.push(i)}else a.push({line:1,column:1,reason:"ERROR: 找不到文件 `"+e+"` , 导入失败"})}}):a.push({line:1,column:1,reason:"ERROR: 找不到资源路径, 无法处理@import"})),r}function parse(e,t){var a,s={},r=[],o=e.code||"",i=e.filePath,n=_path.default.dirname(i),l=[];o=processImport(o,n,r,l);var u=_css.default.parse(o,{silent:!0});u.stylesheet.parsingErrors&&u.stylesheet.parsingErrors.length&&(a=u.stylesheet.parsingErrors,a.forEach(function(e){r.push({line:e.line,column:e.column,reason:e.toString()})})),u&&"stylesheet"===u.type&&u.stylesheet&&u.stylesheet.rules&&u.stylesheet.rules.length&&u.stylesheet.rules.forEach(function(e){var t=e.type,a={};if("rule"===t){if(e.declarations&&e.declarations.length){e.declarations.forEach(function(e){if("declaration"===e.type){var t=e.property,s=e.value,o=(0,_utils.hyphenedToCamelCase)(t),n=(0,_validator.validate)(o,s,{filePath:i});n.value.forEach(function(e){(0,_utils.isValidValue)(e.v)&&(a[e.n]=e.v)}),n.log&&r.push({line:e.position.start.line,column:e.position.start.column,reason:n.log.reason})}});var o=/^[.#]?[A-Za-z0-9_\-:]+$/,n=/^([.#]?[A-Za-z0-9_-]+(\s+|\s*>\s*))+([.#]?[A-Za-z0-9_\-:]+)$/;e.selectors.forEach(function(t){var i={key:t,val:a};if(t.match(o)||t.match(n)){if(!processPseudoClass(i,r,e))return;if(s[i.key]&&t===i.key&&!(0,_utils.equals)(s[i.key],i.val,cssCompare)&&r.push({line:e.position.start.line,column:e.position.start.column,reason:"WARN: 选择器 `"+i.key+"` 已经存在，后者合并前者"}),!_config.options.optimizeDescMeta&&t.match(n))try{i.val=Object.assign({},i.val),i.val._meta={},i.val._meta.ruleDef=(0,_compress.compressDescSelector)((0,_cssWhat.default)(i.key))}catch(t){return void r.push({line:e.position.start.line,column:e.position.start.column,reason:"ERROR: 选择器 `"+i.key+"` 不支持"})}s[i.key]=(0,_utils.extend)({},s[i.key]||{},i.val)}else r.push({line:e.position.start.line,column:e.position.start.column,reason:"ERROR: 选择器 `"+t+"` 非法"})})}}else if("font-face"===t){if(e.declarations&&e.declarations.length){var l={};e.declarations.forEach(function(e){if("declaration"===e.type){var t=(0,_utils.hyphenedToCamelCase)(e.property),a=e.value;if("fontFamily"===t)l.fontName=a.replace(/['"]+/g,"");else if("src"===t){var s=(0,_validator.validate)("fontSrc",a,{filePath:i});s.log&&r.push({line:e.position.start.line,column:e.position.start.column,reason:s.log.reason}),l.fontSrc=s.value}}}),s["@FONT-FACE"]||(s["@FONT-FACE"]={}),s["@FONT-FACE"][l.fontName]=l}}else if("keyframes"===t&&e.keyframes&&e.keyframes.length){var u=e.name,c=[];e.keyframes.forEach(function(t){var a;if("keyframe"===t.type&&t.declarations&&t.declarations.length)if(a={},t.declarations.forEach(function(e){if("declaration"===e.type){var t=e.property,s=e.value,o=(0,_utils.hyphenedToCamelCase)(t),i=(0,_validator.validate)(o,s);i.value.forEach(function(e){(0,_utils.isValidValue)(e.v)&&(a[e.n]=e.v)}),i.log&&r.push({line:e.position.start.line,column:e.position.start.column,reason:i.log.reason})}}),(0,_utils.isEmptyObject)(a))r.push({line:e.position.start.line,column:e.position.start.column,reason:"ERROR: 动画 `"+u+"` 的关键帧 `"+JSON.stringify(t.values)+"` 没有有效的属性"});else{var s;t.values.forEach(function(e){s="from"===e?0:"to"===e?100:parseFloat(e.replace("%","")),a.time=s,c.push(a)})}}),c.sort(function(e,t){return e.time-t.time}),s["@KEYFRAMES"]||(s["@KEYFRAMES"]={}),s["@KEYFRAMES"][u]=c}}),_config.options.optimizeCssAttr&&(0,_compress.compressCssAttr)(s),t(a,{jsonStyle:s,depList:l,log:r})}function processPseudoClass(e,t,a){var s=e.key.indexOf(":");if(s>-1){var r=e.key.slice(s);if(!(0,_validator.validatePseudoClass)(r))return t.push({line:a.position.start.line,column:a.position.start.column,reason:"ERROR: 不支持伪类选择器`"+r+"`"}),!1;e.key=e.key.slice(0,s);var o={};Object.keys(e.val).forEach(function(t){o[t+r]=e.val[t]}),e.val=o}return!0}function cssCompare(e,t,a){if("_meta"===a)return!0}var _fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_css=_interopRequireDefault(require("css")),_cssWhat=_interopRequireDefault(require("css-what")),_validator=require("./validator"),_compress=require("./compress"),_config=require("../../common/config"),_utils=require("../../common/utils");module.exports={parse:parse,validateDelaration:_validator.validate};