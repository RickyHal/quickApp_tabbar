"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function calcSubTextNodesNum(e,t){var a=0;if(_validator.default.isSupportSpan(e)){var r=_validator.default.getTagChildren(e);t.forEach(function(e){("#text"===e.nodeName&&e.value.trim()||r.indexOf(e.nodeName)>-1)&&++a})}return a}function traverse(e,t,a,r,l){_validator.default.checkTagName(e,t,l),(e.attrs||[]).forEach(function(o){var i=o.name,n=i.match(/^:+/);n&&(i=i.slice(n.length));var s=o.value,u={line:1,column:1};switch(e.__location&&(u={line:e.__location.line,column:e.__location.col}),i){case"id":_validator.default.checkId(s,t),_validator.default.checkAttr(i,s,t,e.tagName,u);break;case"class":_validator.default.checkClass(s,t);break;case"style":_validator.default.checkStyle(s,t,u,l);break;case"if":e._isroot||_validator.default.checkIf(s,t,!1,u,r);break;case"else":e._isroot||a&&a.__cond__&&_validator.default.checkElse(a.__cond__,t,u,r);break;case"elif":e._isroot||a&&a.__cond__&&(e.__cond__=_validator.default.checkElif(s,a.__cond__,t,u,r));break;case"for":e._isroot||_validator.default.checkFor(s,t,u);break;case"tree":_validator.default.checkBuild("tree",t);break;default:i.match(/^(on|@)/)?_validator.default.checkEvent(i,s,t):_validator.default.checkAttr(i,s,t,e.tagName,u)}});var o=t.result,i=e.childNodes;if(i&&i.length){var n,s=[],u=calcSubTextNodesNum(o.type,i);i.forEach(function(a,r){if(r>0){var c=i[r-1];c.nodeName.match(/^#/)||(n=c,n.__cond__||n.attrs&&n.attrs.forEach(function(e){"if"!==e.name&&"elif"!==e.name||(n.__cond__=e.value)}))}var _={};if(a.nodeName.match(/^#/)){if("#text"===a.nodeName&&a.value.trim()){if(_validator.default.isSupportSpan(e.tagName)&&u>=2&&(_.type="span",t.result=_,o.children=o.children||[],o.children.push(_),_validator.default.checkAttr("value",a.value,t)),"option"===e.tagName){var d=t.result;return t.result=o,o.attr.hasOwnProperty("value")||_validator.default.checkAttr("value",a.value,t),_validator.default.checkAttr("content",a.value,t),void(t.result=d)}if(_validator.default.isSupportSpan(e.tagName)&&1===u||_validator.default.isTextContentAomtic(e.tagName)){var f=t.result;t.result=o,_validator.default.checkAttr("value",a.value,t),t.result=f}}}else t.result=_,o.children=o.children||[],o.children.push(_),traverse(a,t,n,s,l)}),o.children&&0===o.children.length&&(o.children=void 0)}t.result=o}function initParser(e,t){function a(e){if(e.tagName){var t=e.tagName.toLowerCase(),a=e.selfClosing,l=_validator.default.isSupportedSelfClosing(t),o=_validator.default.isEmptyElement(t);if(r.__m.tagName&&!r.__m.selfClosing&&!o){var i=String(e.location.line)+String(e.location.col);(!l||i!==r.__m.pos&&e.type===_tokenizer.default.START_TAG_TOKEN)&&(_utils.colorconsole.warn(t+"标签要闭合，请遵循XML规范"),r.__m={})}l&&(e.type!==_tokenizer.default.START_TAG_TOKEN||a||(r.__m.tagName=t,r.__m.selfClosing=!1,r.__m.pos=String(e.location.line)+String(e.location.col)),e.type===_tokenizer.default.END_TAG_TOKEN&&t===r.__m.tagName&&(r.__m.selfClosing=!0))}}var r=new _parser.default(t),l=r._appendElement,o=r._insertElement;return r._insertElement=function(e,t){var a=(e.tagName||"").toLowerCase(),r=e.selfClosing,i=_validator.default.isSupportedSelfClosing(a);r&&!i&&_utils.colorconsole.error(a+"标签，禁止使用自闭合"),i||r&&a?l.apply(this,arguments):o.apply(this,arguments)},r.__m={},r._runParsingLoop=function(e){for(;!this.stopped;){this._setupTokenizerCDATAMode();var t=this.tokenizer.getNextToken();if(a(t),t.type===_tokenizer.default.HIBERNATION_TOKEN)break;if(this.skipNextNewLine&&(this.skipNextNewLine=!1,t.type===_tokenizer.default.WHITESPACE_CHARACTER_TOKEN&&"\n"===t.chars[0])){if(1===t.chars.length)continue;t.chars=t.chars.substr(1)}if(this._processInputToken(t),e&&this.pendingScript)break}},r.parseFragment(e)}function parse(e,t,a){var r=initParser(e,{treeAdapter:_parse.default.treeAdapters.default,locationInfo:!0}),l={result:{},log:[]};if(!r||!r.childNodes)return l.log.push({reason:"ERROR: <template>解析失败",line:1,column:1}),void a(null,{jsonTemplate:l.result,log:l.log});var o=r.childNodes.filter(function(e){return"#"!==e.nodeName.charAt(0)});if(0===o.length)return l.log.push({reason:"ERROR: 没有合法的根节点",line:1,column:1}),void a(null,{jsonTemplate:l.result,log:l.log});if(o.length>1)return l.log.push({reason:"ERROR: <template>节点里只能有一个根节点",line:1,column:1}),void a(null,{jsonTemplate:l.result,log:l.log});var i=o[0];i._isroot=!0,traverse(i,l,null,null,t),_config.options.optimizeTemplateAttr&&(0,_compress.compressTemplateAttr)(l.result),a(null,{jsonTemplate:l.result,log:l.log})}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _parse=_interopRequireDefault(require("parse5")),_parser=_interopRequireDefault(require("parse5/lib/parser")),_tokenizer=_interopRequireDefault(require("parse5/lib/tokenizer")),_validator=_interopRequireDefault(require("./validator")),_compress=require("./compress"),_config=require("../../common/config"),_utils=require("../../common/utils"),_default={parse:parse};exports.default=_default;