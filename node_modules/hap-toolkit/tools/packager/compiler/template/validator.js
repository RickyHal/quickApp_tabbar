"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var a in e)if(Object.prototype.hasOwnProperty.call(e,a)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,a):{};n.get||n.set?Object.defineProperty(t,a,n):t[a]=e[a]}return t.default=e,t}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function checkTagName(e,t){var a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=t.result,r=t.log,s=e.tagName,i=e.childNodes||[],l=e.__location||{};tagAliasMap[s]&&("img"!==s&&r.push({line:l.line||1,column:l.col||1,reason:"NOTE: 组件名 `"+s+"` 自动转换为 `"+tagAliasMap[s]+"`"}),s=tagAliasMap[s]),n.type=s,RESERVED_TAGS.indexOf(s)>=0&&r.push({line:l.line||1,column:l.col||1,reason:"ERROR: 组件名 `"+s+"` 非法, 请修改"}),a.uxType===_utils.UX_TYPE.CARD&&tagNatives[s]&&!tagNatives[s].supportCard&&r.push({line:l.line||1,column:l.col||1,reason:"ERROR: 卡片不支持组件名 `"+s+"`, 请修改"}),e._isroot&&tagNotRoot.indexOf(s)>=0&&r.push({line:l.line||1,column:l.col||1,reason:"ERROR: 组件 `"+s+"` 不能作为根组件"}),tagAtomics.indexOf(s)>=0&&(tagTextCotent.indexOf(s)<0?i.length>0&&i.every(function(e){return"#text"===e.nodeName||(r.push({line:l.line||1,column:l.col||1,reason:"ERROR: 组件 `"+s+"` 是原子类型，不应该有子节点"}),!1)}):(i.length>1||i[0]&&"#text"!==i[0].nodeName)&&r.push({line:l.line||1,column:l.col||1,reason:"ERROR: 组件 `"+s+"` 只能有一个文字子节点"})),n.attr=n.attr||{};var o=e.attrs||[],u=[];if(o.forEach(function(e){u.push(e.name.toLowerCase())}),tagDefaultAttrMap[s]&&Object.keys(tagDefaultAttrMap[s]).forEach(function(e){var t=u.indexOf(e);t>=0&&""===o[t].value&&(o[t].value=tagDefaultAttrMap[s][e],r.push({line:l.line||1,column:l.col||1,reason:"ERROR: 组件 `"+s+"` 属性 `"+e+"` 值为空, 默认设置为缺省值 `"+tagDefaultAttrMap[s][e]+"`"}))}),e._isroot){var c=["for","if","elif","else","show"];u.forEach(function(e){c.indexOf(e)>=0&&r.push({line:l.line||1,column:l.col||1,reason:"ERROR: 根节点 `"+s+"` 不能使用属性 `"+e+"`"})})}if(tagRequireAttrMap[s]&&tagRequireAttrMap[s].forEach(function(e){u.indexOf(e)<0&&r.push({line:l.line||1,column:l.col||1,reason:"ERROR: 组件 `"+s+"` 没有定义属性 `"+e+"`"})}),tagEnumAttrMap[s]&&Object.keys(tagEnumAttrMap[s]).forEach(function(e){var t=u.indexOf(e);if(t>=0){var a=o[t].value;if(!_exp.default.isExpr(a)){var n=tagEnumAttrMap[s][e];n.indexOf(a)<0&&(o[t].value=n[0],r.push({line:l.line||1,column:l.col||1,reason:"ERROR: 组件 `"+s+"` 属性 `"+e+"` 的值 `"+a+"`非法, 默认设置为缺省值 `"+n[0]+"`"}))}}}),tagAttrMap[s]&&u.forEach(function(e){e.match(/^(on|@)/)||e in tagAttrMap[s]||r.push({line:l.line||1,column:l.col||1,reason:"ERROR: 组件 `"+s+"` 不支持属性 `"+e+"`，支持的属性有 ["+Object.keys(tagAttrMap[s]).join(", ")+"]"})}),tagEventsMap[s]){var p=tagEventsMap[s];u.forEach(function(e){if(e.match(/^(on|@)/)){var t=e.replace(/^(on|@)/,""),n=["appear","disappear","swipe"];a.uxType===_utils.UX_TYPE.CARD&&n.indexOf(t.toLowerCase())>-1&&r.push({line:l.line||1,column:l.col||1,reason:"ERROR: 卡片组件 `"+s+"` 不支持事件 `"+t+"`"}),p.indexOf(t.toLowerCase())<0&&r.push({line:l.line||1,column:l.col||1,reason:"ERROR: 组件 `"+s+"` 不支持事件 `"+t+"`"})}})}i.length>0&&i.forEach(function(e){if(isReservedTag(s)&&isReservedTag(e.nodeName)){var t=tagParentsMap[e.nodeName],a=tagChildrenMap[s];(t&&t.indexOf(s)<0||a&&a.indexOf(e.nodeName)<0)&&r.push({line:l.line||1,column:l.col||1,reason:"ERROR: 组件 `"+s+"` 不支持子组件 `"+e.nodeName+"`"})}})}function checkId(e,t){e&&(t.result.id=_exp.default.isExpr(e)?(0,_exp.default)(e):e)}function checkBuild(e,t){e&&(t.result.append="tree"===e?"tree":"single")}function checkClass(className,output){var hasBinding,classList=[];if(className=className.trim()){var start=0,end=0,segs=[],matched=className.match(/{{[^]*?}}/g);if(matched){var staticString;matched.forEach(function(e){end=className.indexOf(e,start),staticString=className.slice(start,end),staticString.length&&segs.push(staticString),segs.push(e),start+=staticString.length+e.length})}if(segs.push(className.slice(start)),classList=segs.reduce(function(e,t){return _exp.default.isExpr(t)?(hasBinding=!0,e.push((0,_exp.default)(t,!1)),e):e.concat(t.split(/\s+/g).filter(function(e){return e}).map(function(e){return"'".concat(e,"'")}))},[]),classList=classList.filter(function(e){return e.trim()}),hasBinding){var code="(function () {return ["+classList.join(", ")+"]})";output.result.classList=eval(code)}else output.result.classList=classList.map(function(e){return e.slice(1,-1)})}}function checkStyle(e,t,a,n){var r={},s=t.log;if(e){if(_exp.default.singleExpr(e)){var i=_exp.default.removeExprffix(e);return _exp.default.isExpr(i)?s.push({line:a.line||1,column:a.col||1,reason:"ERROR: style 属性不能嵌套多层{{}}"}):r=(0,_exp.default)(e),void(t.result.style=r)}e.split(";").forEach(function(e){var t,i,l,o=e.trim().split(":");o.length>2&&(o[1]=o.slice(1).join(":"),o=o.slice(0,2)),2===o.length&&(t=o[0].trim(),t=(0,_utils.hyphenedToCamelCase)(t),i=o[1].trim(),i=(0,_exp.default)(i),l=_style.default.validateDelaration(t,i,n),i=l.value,i.forEach(function(e){((0,_utils.isValidValue)(e.v)||"function"==typeof e.v)&&(r[e.n]=e.v)}),l.log&&s.push({line:a.line||1,column:a.col||1,reason:l.log.reason}))}),t.result.style=r}}function checkIf(e,t,a,n,r){var s=t.log;e?(e=_exp.default.addExprffix(e),a?e="{{"+buildConditionExp(r)+"}}":(r.length>0&&(r.length=0),r.push("".concat(e.substr(2,e.length-4)))),t.result.shown=(0,_exp.default)(e)):a||s.push({line:n.line||1,column:n.col||1,reason:"WARNING: if 属性为空"})}function checkElse(e,t,a,n){checkIf(e,t,!0,a,n),n.length=0}function checkElif(e,t,a,n,r){var s=a.log,i=t;return e?(e=_exp.default.addExprffix(e),t=_exp.default.addExprffix(t),i="{{("+e.substr(2,e.length-4)+") && "+buildConditionExp(r)+"}}",a.result.shown=(0,_exp.default)(i),r.push("".concat(e.substr(2,e.length-4)))):s.push({line:n.line||1,column:n.col||1,reason:"WARNING: Elif 属性为空"}),i}function checkFor(e,t,a){var n=t.log;if(e){e=_exp.default.removeExprffix(e);var r,s,i=e.match(/(.*) (?:in) (.*)/);if(i){var l=i[1].match(/\((.*),(.*)\)/);l?(r=l[1].trim(),s=l[2].trim()):s=i[1].trim(),e=i[2]}e="{{"+e+"}}";var o;r||s?(o={exp:(0,_exp.default)(e)},r&&(o.key=r),s&&(o.value=s)):o=(0,_exp.default)(e),t.result.repeat=o}else n.push({line:a.line||1,column:a.col||1,reason:"WARNING: for 属性为空"})}function checkEvent(name,value,output){var eventName=name.replace(/^(on|@)/,"");if(eventName&&value){value=_exp.default.removeExprffix(value);var paramsMatch=value.match(/(.*)\((.*)\)/);if(paramsMatch){var funcName=paramsMatch[1],params=paramsMatch[2];params?(params=params.split(/\s*,\s*/),-1===params.indexOf("evt")&&(params[params.length]="evt")):params=["evt"],value="{{"+funcName+"("+params.join(",")+")}}",value=eval("(function (evt) {"+(0,_exp.default)(value,!1).replace("this.evt","evt")+"})")}output.result.events=output.result.events||{},output.result.events[eventName]=value}}function checkAttr(e,t,a,n,r){e&&(0,_utils.isValidValue)(t)&&(a.result.attr=a.result.attr||{},a.result.attr[(0,_utils.hyphenedToCamelCase)(e)]=(0,_exp.default)(t),"value"===e&&"text"===n&&a.log.push({line:r.line,column:r.column,reason:"WARNING: `value` 应该写在<text>标签中"}))}function isReservedTag(e){return tagReserved.indexOf(e)>-1}function isTextContentAomtic(e){return tagTextCotent.indexOf(e)>-1&&tagAtomics.indexOf(e)>-1}function isSupportSpan(e){if(e&&"string"==typeof e)return tagChildrenMap[e]&&tagChildrenMap[e].indexOf("span")>-1}function getTagChildren(e){if(e&&"string"==typeof e)return tagChildrenMap[e]||[]}function isSupportedSelfClosing(e){if(e&&"string"==typeof e)return e=tagAliasMap[e]||e,tagNatives[e]&&!!tagNatives[e].selfClosing}function isEmptyElement(e){return e=tagAliasMap[e]||e,tagNatives[e]&&!0===tagNatives[e].empty}function buildConditionExp(e){return e.map(function(e){return"!(".concat(e,")")}).join(" && ")}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _exp=_interopRequireDefault(require("./exp")),_style=_interopRequireDefault(require("../style")),info=_interopRequireWildcard(require("../../common/info")),_utils=require("../../common/utils"),RESERVED_TAGS=Object.keys(_utils.FRAG_TYPE).map(function(e){return _utils.FRAG_TYPE[e]}),tagCommon={events:["click","focus","blur","longpress","appear","disappear","swipe"],attrs:{id:{},style:{},class:{},disabled:{enum:["false","true"]},if:{def:"true"},elif:{def:"true"},else:{},for:{},tid:{},show:{def:"true"}},children:["block","slot"],parents:["block"]},tagNatives={div:{supportCard:!0},a:{supportCard:!0,textContent:!0,children:["span"],attrs:{visited:{enum:["false","true"]},href:{}}},text:{supportCard:!0,textContent:!0,children:["a","span"],attrs:{type:{enum:["text","html"]}}},span:{supportCard:!0,textContent:!0,atomic:!0,excludeRoot:!0,parents:["text","a"],attrs:{extendCommon:!1,id:{},style:{},class:{},for:{},tid:{},if:{def:"true"},elif:{def:"true"},else:{}}},label:{supportCard:!0,textContent:!0,atomic:!0,attrs:{target:{}}},image:{empty:!0,supportCard:!0,selfClosing:!0,alias:["img"],atomic:!0,attrs:{src:{},alt:{}}},slider:{selfClosing:!0,atomic:!0,attrs:{enabled:{enum:["true","false"]},min:{def:0},max:{def:100},step:{def:1},value:{def:0}},events:["change"]},web:{atomic:!0,events:["pagestart","pagefinish","titlereceive","error"],attrs:{src:{},trustedurl:{},allowthirdpartycookies:{enum:["false","true"]}}},list:{children:["list-item"],attrs:{scrollpage:{enum:["false","true"]}},events:["scroll","scrollbottom","scrolltop"]},"list-item":{excludeRoot:!0,parents:["list"],attrs:{type:{required:!0}}},block:{excludeRoot:!0,attrs:{extendCommon:!1,for:{},tid:{},if:{def:"true"},elif:{def:"true"},else:{}}},slot:{selfClosing:!0,atomic:!0,excludeRoot:!0,attrs:{extendCommon:!1,content:{}}},input:{supportCard:!0,selfClosing:!0,atomic:!0,empty:!0,attrs:{type:{enum:["text","button","checkbox","radio","email","date","time","number","password"]},enterkeytype:{enum:["default","next","go","done","send","search"]},maxlength:{},checked:{enum:["false","true"]},name:{},value:{},placeholder:{}},events:["change","enterkeyclick"]},button:{supportCard:!0,textContent:!0,atomic:!0},refresh:{attrs:{offset:{def:"132px"},refreshing:{enum:["false","true"]}},events:["refresh"]},swiper:{attrs:{index:{def:0},autoplay:{enum:["false","true"]},interval:{def:3e3},indicator:{enum:["true","false"]},loop:{enum:["true","false"]}},events:["change"]},progress:{supportCard:!0,selfClosing:!0,atomic:!0,attrs:{percent:{def:0},type:{enum:["horizontal","circular"]}}},picker:{supportCard:!0,selfClosing:!0,atomic:!0,attrs:{type:{required:!0,enum:["text","date","time","multi-text"]},start:{def:"1970-1-1"},end:{def:"2100-12-31"},range:{},selected:{},value:{}},events:["change","columnchange","cancel"]},switch:{supportCard:!0,selfClosing:!0,atomic:!0,attrs:{checked:{enum:["false","true"]}},events:["change"]},textarea:{supportCard:!0,atomic:!0,textContent:!0,attrs:{placeholder:{},maxlength:{}},events:["change"]},video:{atomic:!0,attrs:{src:{},autoplay:{enum:["false","true"]},controls:{enum:["true","false"]},poster:{}},events:["prepared","start","pause","finish","error","seeking","seeked","timeupdate","fullscreenchange"]},map:{atomic:!0,selfClosing:!0,attrs:{latitude:{},longitude:{},coordtype:{},scale:{def:0},rotate:{def:0},markers:{},showmylocation:{enum:["true","false"]},polylines:{},circles:{},controls:{},groundoverlays:{},includepoints:{}},events:["loaded","regionchange","tap","markertap","callouttap","controltap"]},canvas:{atomic:!0},stack:{supportCard:!0},richtext:{textContent:!0,atomic:!0,attrs:{type:{required:!0,enum:["html"].concat(info.name.richtextType)}}},tabs:{children:["tab-bar","tab-content"],attrs:{index:{def:0}},events:["change"]},"tab-content":{parents:["tabs"]},"tab-bar":{parents:["tabs"],attrs:{mode:{enum:["fixed","scrollable"]}}},popup:{supportCard:!0,children:["text"],attrs:{target:{required:!0},placement:{enum:["left","top","right","bottom","topLeft","topRight","bottomLeft","bottomRight"],def:"bottom"}},events:["visibilitychange"]},rating:{supportCard:!0,atomic:!0,attrs:{numstars:{def:"5"},rating:{def:"0"},stepsize:{def:"0.5"},indicator:{enum:["false","true"]}},events:["change"]},select:{supportCard:!0,children:["option"],events:["change"],excludeRoot:!0},option:{supportCard:!0,parents:["select"],atomic:!0,textContent:!0,attrs:{selected:{def:!1},value:{}},excludeRoot:!0}},tagReserved=[],tagAliasMap={},tagAttrMap={},tagEnumAttrMap={},tagDefaultAttrMap={},tagRequireAttrMap={},tagAtomics=[],tagTextCotent=[],tagChildrenMap={},tagParentsMap={},tagEventsMap={},tagNotRoot=[];!function(){Object.keys(tagNatives).forEach(function(e){tagReserved.push(e);var t=tagNatives[e];t.atomic&&tagAtomics.push(e),t.textContent&&tagTextCotent.push(e),t.alias&&t.alias.length&&t.alias.forEach(function(t){tagAliasMap[t]=e}),!0===t.excludeRoot&&tagNotRoot.push(e);var a=(0,_utils.extend)({},t.attrs),n={},r={},s=[];t.attrs&&!1===t.attrs.extendCommon||(a=(0,_utils.extend)(a,tagCommon.attrs)),"extendCommon"in a&&delete a.extendCommon,Object.keys(a).forEach(function(e){var t=a[e];t.enum&&t.enum.length>0&&(n[e]=t.enum,r[e]=t.enum[0]),t.def&&(r[e]=t.def),!0===t.required&&s.push(e)}),tagAttrMap[e]=a,tagEnumAttrMap[e]=n,tagDefaultAttrMap[e]=r,tagRequireAttrMap[e]=s,tagChildrenMap[e]=t.children?(0,_utils.merge)([],tagCommon.children,t.children):null,tagParentsMap[e]=t.parents?(0,_utils.merge)([],tagCommon.parents,t.parents):null,tagEventsMap[e]=(0,_utils.merge)([],tagCommon.events,t.events)})}();var _default={checkTagName:checkTagName,checkId:checkId,checkClass:checkClass,checkStyle:checkStyle,checkIf:checkIf,checkElse:checkElse,checkElif:checkElif,checkFor:checkFor,checkEvent:checkEvent,checkAttr:checkAttr,checkBuild:checkBuild,isReservedTag:isReservedTag,isTextContentAomtic:isTextContentAomtic,isSupportSpan:isSupportSpan,getTagChildren:getTagChildren,isSupportedSelfClosing:isSupportedSelfClosing,isEmptyElement:isEmptyElement};exports.default=_default;