"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}function _iterableToArrayLimit(e,t){var n=[],o=!0,r=!1,s=void 0;try{for(var i,a=e[Symbol.iterator]();!(o=(i=a.next()).done)&&(n.push(i.value),!t||n.length!==t);o=!0);}catch(e){r=!0,s=e}finally{try{o||null==a.return||a.return()}finally{if(r)throw s}}return n}function _arrayWithHoles(e){if(Array.isArray(e))return e}var _fs=_interopRequireDefault(require("fs")),_loaderUtils=_interopRequireDefault(require("loader-utils")),_compiler=require("../../compiler"),_info=require("../../common/info"),_utils=require("../../common/utils");module.exports=function(e,t){var n=this;this.cacheable&&this.cacheable();var o=this.async(),r=_loaderUtils.default.parseQuery(this.query),s=_loaderUtils.default.parseQuery(this.resourceQuery)||{},i=r.type,a=s.uxType,l=this.resourcePath,c=r.index;null!=c&&c.match(/^\d+$/)&&(c=parseInt(c)),Promise.resolve((0,_compiler.parseFragmentsWithCache)(e,l)[i]).then(function(o){null!=c&&(o=o[c]);var r=o.content.trim();if(i===_utils.FRAG_TYPE.SCRIPT&&(0,_utils.isUXEntry)(a)&&"Y"===process.env.NODE_TEST)if(l.match(/src\/app\./))r="import '../node_modules/".concat(_info.moduleName,"/tools/packager/common/app.js'\n ").concat(r);else{var s=l.replace("/src/","/test/").replace(/\.\w{2,5}$/,".js");if(_fs.default.existsSync(s)){var u=s.match(/\/test\/(.*)/)[1];r="\nimport fnTestCase from '".concat(u,"'\n").concat(r),r=r.replace("export default {","export default {\n    onCreate () {\n      // 允许back被外部覆盖\n      if (this._options._descriptor) {\n        this._options._descriptor['back'] = {access: 'public'}\n      }\n\n      // 测试执行：开始时间，结束事件\n      global.CASE_TEST_START = global.CASE_TEST_START || 1000\n      global.CASE_TEST_TIMEOUT = global.CASE_TEST_TIMEOUT || 2000\n\n      global.mocha = new Mocha({ reporter: 'json', timeout: global.CASE_TEST_TIMEOUT })\n      mocha.ui('bdd')\n      mocha.suite.emit('pre-require', global, null, mocha);\n      setTimeout(function() {\n        // 记录测试用例\n        typeof fnTestCase === 'function' && fnTestCase(this)\n        var mochaRunner = mocha.run(function () {\n          if (mochaRunner) {\n            // 标题\n            mochaRunner.testResults.stats.title = mocha.suite.suites && mocha.suite.suites[0] && mocha.suite.suites[0].title\n            console.info('testResults: ', JSON.stringify(mochaRunner.testResults))\n            pushData('pageTestList', mochaRunner.testResults)\n\n            // 显示结果\n            const stats = mochaRunner.testResults.stats\n            this.$page.setTitleBar({ text: `通过/全部: ${stats.passes}/${stats.tests}` })\n          }\n\n          // 是否返回\n          if (this.back !== 'false') {\n            console.info('拥有关联测试用例，测试完毕，返回到之前的页面')\n            history.back()\n          }\n        }.bind(this))\n      }.bind(this), global.CASE_TEST_START)\n    },"),_utils.colorconsole.info("[INFO] 脚本注入测试用例：".concat(u))}else r=r.replace("export default {","export default {\n    onCreate () {\n      // 允许back被外部覆盖\n      if (this._options._descriptor) {\n        this._options._descriptor['back'] = {access: 'public'}\n      }\n\n      // 测试执行：开始时间，结束事件\n      global.CASE_TEST_START = global.CASE_TEST_START || 1000\n      global.CASE_TEST_TIMEOUT = global.CASE_TEST_TIMEOUT || 2000\n\n      setTimeout(function() {\n        // 是否返回\n        if (this.back !== 'false') {\n          console.info('没有关联测试用例，直接返回到之前的页面')\n          history.back()\n        }\n      }.bind(this), global.CASE_TEST_START)\n    },")}var _;if(n.sourceMap&&(i===_utils.FRAG_TYPE.SCRIPT||i===_utils.FRAG_TYPE.IMPORT)){var T,f=o.location.line;t&&(T=(0,_utils.consumeMap)(n,e,t),e=T.sourcesContent.join(""));var p=(0,_utils.splitSourceLine)(r).map(function(e,t){t+=1;var n=t+f,o=t;return T&&(n=T.mapping["line-".concat(n,"-column-0")].line),{original:{line:n,column:0},generated:{line:o,column:0}}});_=(0,_utils.generateMap)(n,e,p)}return[r,_]}).then(function(e){var n=_slicedToArray(e,2),r=n[0],s=n[1];o(null,r,s&&s.toJSON()||t)}).catch(function(e){o(e,"")})};