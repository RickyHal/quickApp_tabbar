"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function loader(e,r){var t=e;t.cacheable&&t.cacheable();var a=_loaderUtils.default.parseQuery(t.resourceQuery),p=t.resourcePath,o=(_path.default.relative(".",p),a.uxType),s=a.name||(0,_utils.getNameByPath)(p);_validator.default.isReservedTag(s)&&(0,_utils.logWarn)(t,[{reason:"脚本文件名不能使用保留字:"+s}]),(0,_utils.print)({resourceQuery:t.resourceQuery,resourcePath:t.resourcePath,name:s});var i=(0,_compiler.parseFragmentsWithCache)(r,p);return(0,_utils.print)(i),parseImportList(t,i.import).then(function(){return assemble(t,i,s,o,p)})}function parseImportList(e,r){return Promise.all(r.map(function(r){return resolveImportItemSrc(e,r)}))}function resolveImportItemSrc(e,r){return r.attrs.src?new Promise(function(t){e.resolve(e.context,r.attrs.src,function(e,a){return e?(r.isValid=!1,r.err=e,t(r)):(r.isValid=!0,r.srcPath=a,t(r))})}):(r.isValid=!1,Promise.resolve(r))}function assemble(e,r,t,a,p){var o="";if(a===_utils.UX_TYPE.APP){o+=(0,_uxFragmentUtils.processScriptFrag)(e,r.script,a),o+="\n$app_define$('@app-application/".concat(t,"', [], function($app_require$, $app_exports$, $app_module$){\n"),r.script.length>0&&(o+="     $app_script$($app_module$, $app_exports$, $app_require$)\n",o+="     if ($app_exports$.__esModule && $app_exports$.default) {\n            $app_module$.exports = $app_exports$.default\n        }\n"),o+="})\n";var s=JSON.parse(_fs.default.readFileSync(packagepath).toString());o+="\n$app_bootstrap$('@app-application/".concat(t,"',{ packagerVersion: '").concat(s.subversion.packager,"'})\n")}else{var i=[];if(o+=(0,_uxFragmentUtils.processImportFrag)(e,r.import,i),o+=(0,_uxFragmentUtils.processTemplateFrag)(e,r.template,a),o+=(0,_uxFragmentUtils.processStyleFrag)(e,r.style,a),o+=(0,_uxFragmentUtils.processScriptFrag)(e,r.script,a),o+="\n$app_define$('@app-component/".concat(t,"', [], function($app_require$, $app_exports$, $app_module$){\n"),r.script.length>0&&(o+="     $app_script$($app_module$, $app_exports$, $app_require$)\n",o+="     if ($app_exports$.__esModule && $app_exports$.default) {\n            $app_module$.exports = $app_exports$.default\n        }\n"),o+="     $app_module$.exports.template = $app_template$\n",r.style.length>0&&(o+="     $app_module$.exports.style = $app_style$\n"),o+="})\n",(0,_utils.isUXRender)(a)){var n=JSON.parse(_fs.default.readFileSync(packagepath).toString());o+="\n$app_bootstrap$('@app-component/".concat(t,"',{ packagerVersion: '").concat(n.subversion.packager,"'})\n")}}return o}var _fs=_interopRequireDefault(require("fs")),_md=_interopRequireDefault(require("md5")),_path=_interopRequireDefault(require("path")),_loaderUtils=_interopRequireDefault(require("loader-utils")),_validator=_interopRequireDefault(require("../../compiler/template/validator")),_uxFragmentUtils=require("./ux-fragment-utils"),_compiler=require("../../compiler"),_utils=require("../../common/utils"),loaderPath=__dirname,packagepath=_path.default.resolve(loaderPath,"../../package.json");module.exports=loader;