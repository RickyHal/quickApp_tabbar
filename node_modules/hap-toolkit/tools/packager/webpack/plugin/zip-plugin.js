"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ZipPlugin(e){this.options=Object.assign({priorities:["manifest.json","app.js"]},e)}function resolveFiles(e,i){var t=(0,_utils.lsdirdeep)(e);return t.includes(DIGEST_FILE)?(console.warning("检测到存在快应用保留文件: ".concat(DIGEST_FILE)),!1):t=(0,_utils.sortFilesBy)(t,i)}function zipDigests(e){var i=new _jszip.default;return i.file("hash.json",JSON.stringify({algorithm:"SHA-256",digests:e})),i.generateAsync(COMPRESS_OPTS)}function pack(e){var i=e.files,t=e.digestBuf,n=e.hashList,r=e.base,s=e.privatekey,o=e.certificate,a=new _jszip.default,f={name:Buffer.from("hash.json"),hash:(0,_sign.getBufferDigest)(t)},u=(0,_sign.signZip)({buffer:t,files:[f]},s,o);return a.file(DIGEST_FILE,u),n.unshift({name:Buffer.from(DIGEST_FILE),hash:(0,_sign.getBufferDigest)(u)}),i.forEach(function(e){var i=_path.default.join(r,e);a.file(e,_fs.default.readFileSync(i))}),a.generateAsync(COMPRESS_OPTS)}var _fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_jszip=_interopRequireDefault(require("jszip")),_dayjs=_interopRequireDefault(require("dayjs")),_sign=require("../../common/sign"),_utils=require("../../common/utils"),COMPRESS_OPTS={type:"nodebuffer",compression:"DEFLATE",compressionOptions:{level:9}},DIGEST_FILE="META-INF/CERT",projectRoot=process.cwd(),SignFileConfig={debug:{privatekey:_path.default.join(projectRoot,"sign/debug/private.pem"),certificate:_path.default.join(projectRoot,"sign/debug/certificate.pem")},release:{privatekey:_path.default.join(projectRoot,"sign/release/private.pem"),certificate:_path.default.join(projectRoot,"sign/release/certificate.pem")}};ZipPlugin.prototype.apply=function(e){var i=this.options,t=SignFileConfig[i.sign];e.plugin("after-emit",function(n,r){if(!t)return void _utils.colorconsole.log("### App Loader ### 无签名配置项, 放弃打包: "+i.sign);var s=t.privatekey,o=t.certificate;if(!_fs.default.existsSync(s))return void _utils.colorconsole.log("### App Loader ### 缺少私钥文件, 打包失败: "+s);if(!_fs.default.existsSync(o))return void _utils.colorconsole.log("### App Loader ### 缺少证书文件, 打包失败: "+o);s=_fs.default.readFileSync(s),o=_fs.default.readFileSync(o);var a=[],f=Object.create(null),u=resolveFiles(i.pathBuild,i.priorities);!1!==u&&(u.forEach(function(e){var t=_path.default.join(i.pathBuild,e),n=_fs.default.readFileSync(t);f[e]=(0,_sign.getBufferDigest)(n).toString("hex"),a.push({name:Buffer.from(e),hash:(0,_sign.getBufferDigest)(n)})}),zipDigests(f).then(function(e){return pack({files:u,hashList:a,digestBuf:e,base:i.pathBuild,privatekey:s,certificate:o})}).then(function(t){_fs.default.mkdir(i.output,function(){var n="".concat(i.name,".").concat(i.sign,".rpk"),f=_path.default.join(i.output,n),u=(0,_sign.signZip)({buffer:t,files:a},s,o);if(_fs.default.writeFileSync(f,u),!e.options.watch){var l=(0,_dayjs.default)().format("YYYYMMDDhhmmss"),c="".concat(i.name,"_").concat(i.sign,"_").concat(i.versionCode,"_").concat(l,".rpk"),p=_path.default.join(i.output,c);_fs.default.writeFileSync(p,u),_utils.colorconsole.log("### App Loader ### 复制 rpk 文件(".concat(n,")为文件(").concat(c,")"))}r()})}))})},module.exports=ZipPlugin;