"use strict";function _interopRequireWildcard(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var o in e)if(Object.prototype.hasOwnProperty.call(e,o)){var n=Object.defineProperty&&Object.getOwnPropertyDescriptor?Object.getOwnPropertyDescriptor(e,o):{};n.get||n.set?Object.defineProperty(t,o,n):t[o]=e[o]}return t.default=e,t}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function ResourcePlugin(e){this.options=e}var _path=_interopRequireDefault(require("path")),_aaptjs=_interopRequireDefault(require("aaptjs")),info=_interopRequireWildcard(require("../../common/info")),_shared=require("../../common/shared"),_utils=require("../../common/utils"),FILE_EXT_LIST=info.name.extList,FILE_EXT_NORES=FILE_EXT_LIST.concat([".js",".jsx",".coffee",".ts",".tsx",".vue",".css",".less",".sass",".styl",".html",".json",".md"]),FILE_NAME_NORES=[".DS_Store","Thumbs.db"];ResourcePlugin.prototype.apply=function(e){var t=this.options,o=e.options;e.plugin("watch-run",function(e,t){Object.keys(o.entry).forEach(function(e){var t=o.entry[e];t instanceof Array&&!/app\.js/.test(e)&&-1!==t[0].indexOf("webpack-dev-server")&&t.shift()}),t()}),e.plugin("emit",function(e,o){function n(){--u>0||(_utils.colorconsole.log("### App Loader ### build目录构建完成"),o())}var i=t.pathSrc,r=t.pathBuild,s=e.compiler.inputFileSystem,a=e.compiler.outputFileSystem,c=(0,_utils.collectResFile)(s,i,r,FILE_EXT_NORES,FILE_NAME_NORES),u=Object.keys(c).length;Object.keys(c).forEach(function(e){var t=c[e];a.mkdirp(_path.default.dirname(e),function(){var o=s.statSync(t);if(o&&o.isFile()){/.+\.9\.png$/.test(_path.default.basename(t))?_aaptjs.default.singleCrunch(t,e,function(e){e&&_utils.colorconsole.log("### App Loader ### 转换资源文件(".concat(t,")失败：").concat(e.message)),n()}):s.readFile(t,function(o,i){o&&_utils.colorconsole.log("### App Loader ### 复制资源文件(".concat(t,")失败：").concat(o.message)),a.writeFile(e,i,function(t){t&&_utils.colorconsole.log("### App Loader ### 复制资源文件(".concat(e,")失败：").concat(t.message)),n()})})}})})}),e.plugin("emit",function(e,o){var n=t.pathSrc,i=t.pathBuild,r=e.compiler.inputFileSystem,s=e.compiler.outputFileSystem,a=_path.default.join(n,"manifest.json"),c=_path.default.join(i,"manifest.json");if(-1!==r.readdirSync(n).indexOf("manifest.json")){var u=r.readFileSync(a,"utf8"),l=(0,_shared.updateManifestCont)(u,t).manifestCont;t.sign&&(l=JSON.stringify(JSON.parse(l))),s.writeFile(c,l,"utf8",function(e){e&&_utils.colorconsole.error("### App Loader ### 更新资源文件(".concat(c,")失败：").concat(e.message)),o()})}else _utils.colorconsole.error("### App Loader ### ".concat(n,"目录下无资源文件manifest.json")),o()})},module.exports=ResourcePlugin;