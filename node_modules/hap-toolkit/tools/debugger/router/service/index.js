"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function asyncGeneratorStep(e,r,t,n,o,a,s){try{var i=e[a](s),u=i.value}catch(e){return void t(e)}i.done?r(u):Promise.resolve(u).then(n,o)}function _asyncToGenerator(e){return function(){var r=this,t=arguments;return new Promise(function(n,o){function a(e){asyncGeneratorStep(i,n,o,a,s,"next",e)}function s(e){asyncGeneratorStep(i,n,o,a,s,"throw",e)}var i=e.apply(r,t);a(void 0)})}}function getInspectorUrl(e){var r=e.ws,t=e.serverPort,n="http://".concat((0,_utils.getServerIPAndPort)(t)),o="?ws=".concat(encodeURI(r),"&remoteFrontend=true&dockSide=undocked");return"".concat(n).concat("/inspector/inspector.html").concat(o)}function prepareStartServer(e){return _prepareStartServer.apply(this,arguments)}function _prepareStartServer(){return _prepareStartServer=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,t=routerConf(r.context),e.next=4,untarInspectorTarFile(t);case 4:e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),_utils.colorconsole.error("### App Server ### 解压inspector.tar.gz文件出错: ".concat(e.t0.message));case 9:case"end":return e.stop()}},e,this,[[0,6]])})),_prepareStartServer.apply(this,arguments)}function untarInspectorTarFile(e){var r=e.inspectorTarFile,t=e.inspectorHtmlDir,n=!_fs.default.existsSync(t),o=_fs.default.existsSync(r);if(n)if(o&&n)_tar.default.x({file:r,cwd:_path.default.dirname(r)});else if(!o)throw new Error("缺少devtools inspector工程文件夹")}function routerConf(e){return e.router.conf}function serverConf(e){return e.conf}function getClientFromRequest(e){var r=(0,_utils.getClientIPAddress)(e),t=(0,_utils.getIPv4IPAddress)(),n=e.header["device-serial-number"],o=LINK_MODE.NULL;return"127.0.0.1"===r&&n?o=LINK_MODE.ADB:"127.0.0.1"!==r&&r!==t&&(o=LINK_MODE.WIFI),{clientIp:r,sn:n,linkMode:o}}function getDebugInfoFromRequest(e){var r=getClientFromRequest(e),t=r.sn,n=r.linkMode,o=e.body,a=o.ws;return{sn:t,linkMode:n,ws:a,application:o.application,devicePort:a.split(":")[1].split("/")[0]}}Object.defineProperty(exports,"__esModule",{value:!0}),exports.getInspectorUrl=getInspectorUrl,exports.prepareStartServer=prepareStartServer,exports.untarInspectorTarFile=untarInspectorTarFile,exports.routerConf=routerConf,exports.serverConf=serverConf,exports.getDebugInfoFromRequest=getDebugInfoFromRequest,exports.SOURCE=exports.LINK_MODE=void 0;var _path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_tar=_interopRequireDefault(require("tar")),_utils=require("../../lib/utils"),LINK_MODE={NULL:0,WIFI:1,ADB:2};exports.LINK_MODE=LINK_MODE;var SOURCE={IDE:"ide"};exports.SOURCE=SOURCE;