"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function asyncGeneratorStep(e,r,t,n,a,o,s){try{var i=e[o](s),c=i.value}catch(e){return void t(e)}i.done?r(c):Promise.resolve(c).then(n,a)}function _asyncToGenerator(e){return function(){var r=this,t=arguments;return new Promise(function(n,a){function o(e){asyncGeneratorStep(i,n,a,o,s,"next",e)}function s(e){asyncGeneratorStep(i,n,a,o,s,"throw",e)}var i=e.apply(r,t);o(void 0)})}}function index(e,r){return _index.apply(this,arguments)}function _index(){return _index=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=(0,_service.routerConf)(r),a=n.htmlPageDir,o=_path2.default.join(a,"index.html"),e.prev=2,!_fs.default.existsSync(o)){e.next=8;break}r.set("Content-Type","text/html"),r.body=_fs.default.createReadStream(o),e.next=11;break;case 8:return e.next=10,t();case 10:r.throw("404","无法找到".concat(o,"文件"));case 11:e.next=17;break;case 13:e.prev=13,e.t0=e.catch(2),_utils.colorconsole.error("### App Server ### 无法获取".concat(o,"文件: ").concat(e.t0)),r.body="404 Not found ".concat(o);case 17:return e.abrupt("return");case 18:case"end":return e.stop()}},e,this,[[2,13]])})),_index.apply(this,arguments)}function register(e,r){return _register.apply(this,arguments)}function _register(){return _register=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,a,o,s,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return _utils.colorconsole.info("### App Server ### 收到App注册信息, 格式:\n".concat(JSON.stringify(r.request.body),"\n")),e.next=3,t();case 3:n=r.request.body,a=n.ws,o=n.application,s=(0,_service.serverConf)(r).defaults.serverPort,i=(0,_service.getInspectorUrl)({ws:a,serverPort:s}),emitWSEvent(r.io,"appRegistered",{inspectorUrl:i,application:o}),_utils.colorconsole.info("请访问以下链接进行调试：\n\n".concat(i,"\n"));case 8:case"end":return e.stop()}},e,this)})),_register.apply(this,arguments)}function adapterForBackwardComp(e,r){return _adapterForBackwardComp.apply(this,arguments)}function _adapterForBackwardComp(){return _adapterForBackwardComp=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,a,o,s,i,c,u,p,l;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,n=r.request.body,a=r.method,o=r.path,s="ws"in n&&n.ws.indexOf("inspector")>=0,i="application"in n&&n.application.indexOf("hybrid.loader")>=0,"post"!==a.toLowerCase()||"/"!==o||!s||!i){e.next=15;break}_utils.colorconsole.warn("调试器已有重要更新，请更新调试器"),emitWSEvent(r.io,"informUpdate"),c=n.ws,u=n.application,p=(0,_service.serverConf)(r).defaults.serverPort,l=(0,_service.getInspectorUrl)({ws:c,serverPort:p}),emitWSEvent(r.io,"appRegistered",{inspectorUrl:l,application:u}),_utils.colorconsole.info("请访问以下链接进行调试：\n\n".concat(l,"\n")),e.next=17;break;case 15:return e.next=17,t();case 17:e.next=25;break;case 19:return e.prev=19,e.t0=e.catch(0),_utils.colorconsole.error("### App Server ### 出错信息: ".concat(e.t0.message)),_utils.colorconsole.error("### App Server ### 当前调试器与toolkit不兼容，请更新调试器。"),e.next=25,t();case 25:case"end":return e.stop()}},e,this,[[0,19]])})),_adapterForBackwardComp.apply(this,arguments)}function redirectHtmlReq(e,r){return _redirectHtmlReq.apply(this,arguments)}function _redirectHtmlReq(){return _redirectHtmlReq=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=r.req,a=_url.default.parse(n.url),!/.*\.html?$/.test(a.pathname)||/^\/html/.test(a.pathname)){e.next=7;break}_utils.colorconsole.info("### App Server ### 重定向html文件请求"),r.redirect("/html"+a.path),e.next=9;break;case 7:return e.next=9,t();case 9:case"end":return e.stop()}},e,this)})),_redirectHtmlReq.apply(this,arguments)}function qrCode(e,r){return _qrCode.apply(this,arguments)}function _qrCode(){return _qrCode=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,a,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=(0,_service.serverConf)(r).defaults.serverPort,a="http://".concat((0,_utils.getServerIPAndPort)(n)),o=_qrImage.default.image(a,{size:9}),e.next=5,t();case 5:r.type="image/png",r.body=o;case 7:case"end":return e.stop()}},e,this)})),_qrCode.apply(this,arguments)}function startDebug(e,r){return _startDebug.apply(this,arguments)}function _startDebug(){return _startDebug=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,a,o,s,i,c,u,p,l,d,f;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=(0,_service.getDebugInfoFromRequest)(r.request),a=n.sn,o=n.linkMode,s=n.devicePort,i=n.application,c=n.ws,o!==_service.LINK_MODE.ADB){e.next=15;break}return e.next=6,r.adbDebugger.forwardForWsChannel(a,s);case 6:if(u=e.sent,p=u.localWsPort,!(l=u.err)){e.next=14;break}return console.error("startDebug(): adb forward 端口映射失败: ".concat(l.message)),e.next=13,t();case 13:return e.abrupt("return",e.sent);case 14:c=c.replace(s,p);case 15:if(d=(0,_service.serverConf)(r).defaults.serverPort,f=(0,_service.getInspectorUrl)({ws:c,serverPort:d}),emitWSEvent(r.io,"appRegistered",{inspectorUrl:f,application:i}),_utils.colorconsole.info("请访问以下链接进行调试：\n\n".concat(f,"\n")),r.app.source!==_service.SOURCE.IDE){e.next=23;break}process.send({url:f,type:"openWin"}),e.next=25;break;case 23:return e.next=25,(0,_utils.startChrome)(f,{chromePath:(0,_service.serverConf)(r).options.chromePath});case 25:return e.next=27,t();case 27:case"end":return e.stop()}},e,this)})),_startDebug.apply(this,arguments)}function emitWSEvent(e,r,t){e.sockets.emit(r,t||{})}Object.defineProperty(exports,"__esModule",{value:!0}),exports.redirectHtmlReq=redirectHtmlReq,exports.startDebug=startDebug,exports.default=void 0;var _path2=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_url=_interopRequireDefault(require("url")),_qrImage=_interopRequireDefault(require("qr-image")),_utils=require("../../lib/utils"),_service=require("../service"),_default={index:index,register:register,adapterForBackwardComp:adapterForBackwardComp,redirectHtmlReq:redirectHtmlReq,qrCode:qrCode,startDebug:startDebug};exports.default=_default;