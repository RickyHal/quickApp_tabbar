"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var r=0,t=new Array(e.length);r<e.length;r++)t[r]=e[r];return t}}function asyncGeneratorStep(e,r,t,n,o,i,a){try{var c=e[i](a),s=c.value}catch(e){return void t(e)}c.done?r(s):Promise.resolve(s).then(n,o)}function _asyncToGenerator(e){return function(){var r=this,t=arguments;return new Promise(function(n,o){function i(e){asyncGeneratorStep(c,n,o,i,a,"next",e)}function a(e){asyncGeneratorStep(c,n,o,i,a,"throw",e)}var c=e.apply(r,t);i(void 0)})}}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,r){for(var t=0;t<r.length;t++){var n=r[t];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function _createClass(e,r,t){return r&&_defineProperties(e.prototype,r),t&&_defineProperties(e,t),e}Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_utils=require("../lib/utils"),_debuglog=_interopRequireDefault(require("./debuglog")),_adbDevicesEmitter=_interopRequireDefault(require("adb-devices-emitter")),_adbCommander=_interopRequireDefault(require("adb-commander")),REMOTE_REVERSE_PORT=12306,REMOTE_UP_FORWARD_PORT=39517,ADBModule=function(){function e(r){_classCallCheck(this,e),this.option=r,this.currentDeviceMap=new Map,this.cachedDeviceMap=new Map,this.DEBUG=(process.env.NODE_DEBUG||"").split(",").includes("adb"),this._localUpForwardPort=REMOTE_UP_FORWARD_PORT,this.commander=_adbCommander.default,this.devicesEmitter=_adbDevicesEmitter.default,this._lastPromise=null,this.init()}return _createClass(e,[{key:"init",value:function(){var e=this;(0,_debuglog.default)("init(): start"),this.devicesEmitter.addEventListener("deviceAdded",function(r){e._listen(r,e.onDeviceAdded.bind(e))}),this.devicesEmitter.addEventListener("deviceRemoved",function(r){e._listen(r,e.onDeviceRemoved.bind(e))}),this.devicesEmitter.start()}},{key:"_listen",value:function(e,r){this._lastPromise?this._lastPromise=this._lastPromise.then(function(){return r(e)},function(){return r(e)}):this._lastPromise=r(e)}},{key:"_getNextLocalForwardPort",value:function(){return this._localUpForwardPort++}},{key:"onDeviceAdded",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,o,i,a,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return t=r.sn,_utils.colorconsole.info("### App Server ### 手机设备(".concat(t,")被连入")),n=this.option.localReversePort,e.next=5,this.establishADBProxyLink("reverse",[t,n,REMOTE_REVERSE_PORT]);case 5:if(o=e.sent,!o.err){e.next=9;break}return _utils.colorconsole.error("### App Server ### onDeviceAdded(): (".concat(t,")建立adb reverse失败(local port: ").concat(n,", remote port: ").concat(REMOTE_REVERSE_PORT,")")),e.abrupt("return");case 9:return i=this.cachedDeviceMap.get(t),(0,_debuglog.default)("onDeviceAdded():(".concat(t,")\ncachedDevice:\t").concat(JSON.stringify(i),"\ncachedDeviceList:\t").concat(JSON.stringify(Array.from(this.cachedDeviceMap.entries())))),i&&i.upForwardPortPair||(i={upForwardPortPair:[this._getNextLocalForwardPort(),REMOTE_UP_FORWARD_PORT]}),e.next=14,this.establishADBProxyLink("forward",[t].concat(i.upForwardPortPair));case 14:if(a=e.sent,!a.err){e.next=18;break}return _utils.colorconsole.error("### App Server ### onDeviceAdded(): (".concat(t,")建立adb forward失败(local port: ").concat(i.upForwardPortPair[0],", remote port: ").concat(i.upForwardPortPair[1],") ")),e.abrupt("return");case 18:if(!i.wsPortPair){e.next=23;break}return e.next=21,this.establishADBProxyLink("forward",[t,i.wsPortPair[0],i.wsPortPair[1]]);case 21:c=e.sent,c.err&&(_utils.colorconsole.warn("### App Server ### onDeviceAdded():(".concat(t,") 建立adb forward失败(local port: ").concat(i.wsPortPair[0],", remote port: ").concat(i.wsPortPair[1],")")),i.wsPortPair=void 0);case 23:return this.currentDeviceMap.set(t,i),this.cachedDeviceMap.set(t,i),e.next=27,this._writeClientLogFile({sn:t,ip:"127.0.0.1",port:i.upForwardPortPair[0]});case 27:(0,_debuglog.default)("onDeviceAdded():(".concat(t,") end"));case 28:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}()},{key:"onDeviceRemoved",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(t=r.sn,_utils.colorconsole.info("### App Server ### 手机设备(".concat(t,")被拔出")),this.currentDeviceMap.delete(t),!this.DEBUG){e.next=9;break}return(0,_debuglog.default)("deviceRemoved():(".concat(t,") cachedDeviceList: ").concat(JSON.stringify(Array.from(this.cachedDeviceMap.entries())))),e.next=7,this.commander.print("adb -s ".concat(t," reverse --list"));case 7:return e.next=9,this.commander.print("adb -s ".concat(t," forward --list"));case 9:return e.next=11,this._removeItemFromClientLogFile(t);case 11:(0,_debuglog.default)("deviceRemoved():(".concat(t,") end"));case 12:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}()},{key:"_writeClientLogFile",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,o,i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:try{for(t=this.option.pathClientLog,n=_path.default.dirname(t),(0,_utils.mkdirsSync)(n),o=_fs.default.existsSync(t)?JSON.parse(_fs.default.readFileSync(t)).clients:[],(0,_debuglog.default)("writeClientLogFile(): before: ".concat(JSON.stringify(o))),o=o.filter(function(e){return e.ip!==r.ip||r.port!==r.port});o.length>4;)o.shift();o.push(r),i={clients:o},_fs.default.writeFileSync(t,JSON.stringify(i,null,2)),(0,_debuglog.default)("writeClientLogFile(): after: ".concat(JSON.stringify(o)))}catch(e){_utils.colorconsole.error("### App Server ### writeClientLogFile(): 写入client.json文件出错: ".concat(e.message))}case 1:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}()},{key:"_removeItemFromClientLogFile",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r){var t,n,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:try{t=this.option.pathClientLog,n=JSON.parse(_fs.default.readFileSync(t)).clients,(0,_debuglog.default)("_removeItemFromClientLogFile(): before: ".concat(JSON.stringify(n))),n=n.filter(function(e){return e.sn!==r}),o={clients:n},_fs.default.writeFileSync(t,JSON.stringify(o,null,2)),(0,_debuglog.default)("_removeItemFromClientLogFile(): after: ".concat(JSON.stringify(n)))}catch(e){_utils.colorconsole.error("### App Server ### _removeItemFromClientLogFile(): 移除client.json设备信息出错： ".concat(e.message))}case 1:case"end":return e.stop()}},e,this)}));return function(r){return e.apply(this,arguments)}}()},{key:"forwardForWsChannel",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,o,i,a,c;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(n=this.currentDeviceMap.get(r)){e.next=4;break}return _utils.colorconsole.error("### AppApp Server ### 获取(".concat(r,")设备信息失败")),e.abrupt("return");case 4:if(o=n.wsPortPair,i=t,!o||o[0]!==i||o[1]!==t){e.next=8;break}return e.abrupt("return",{localWsPort:i});case 8:return e.next=10,this.establishADBProxyLink("forward",[r,i,t]);case 10:if(a=e.sent,!(c=a.err)){e.next=16;break}return _utils.colorconsole.error("### AppApp Server ### forwardForWsChannel(): 创建WebSocket端口映射失败"),n.wsPortPair=void 0,e.abrupt("return",{err:c});case 16:return n.wsPortPair=[i,t],e.abrupt("return",{localWsPort:i});case 18:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}()},{key:"establishADBProxyLink",value:function(){var e=_asyncToGenerator(regeneratorRuntime.mark(function e(r,t){var n,o;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,(n=this.commander)[r].apply(n,_toConsumableArray(t));case 2:if(o=e.sent,!this.DEBUG){e.next=7;break}return(0,_debuglog.default)("establishADBReverseLink(): (".concat(t[0],") adb ").concat(r," setup result: ").concat(JSON.stringify(o))),e.next=7,this.commander.print("adb -s ".concat(t[0]," ").concat(r," --list"));case 7:return e.abrupt("return",o);case 8:case"end":return e.stop()}},e,this)}));return function(r,t){return e.apply(this,arguments)}}()}]),e}(),_default=ADBModule;exports.default=_default;