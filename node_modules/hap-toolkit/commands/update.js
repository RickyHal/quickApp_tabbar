"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function checkVersion(){var e,a={cur:"",toolkit:"",res:0},t=_path.default.join(curDir,"package.json");_fsExtra.default.existsSync(t)&&(e=JSON.parse(_fsExtra.default.readFileSync(t).toString()),a.cur=e.subversion&&e.subversion.toolkit||""),""===a.cur&&(a.res=1);var o=_path.default.join(toolkitDir,"package.json");return _fsExtra.default.existsSync(o)&&(e=JSON.parse(_fsExtra.default.readFileSync(o).toString()),a.toolkit=e.version||""),""===a.toolkit?(console.log("### App Toolkit ### 当前toolkit的文件错误, 无法升级, 请重新安装后再升级"),a.res=-1,a):(1!==a.res&&(a.res=_semver.default.gt(a.toolkit,a.cur)?1:0),a)}function mergeProps(e,a){if(e)for(var t in a)e[t]||-1!==t.indexOf("babel-")||(e[t]=a[t])}function upgradePackage(){console.log(_chalk.default.green("升级 package.json"));var e={},a=_path.default.join(curDir,"package.json");_fsExtra.default.existsSync(a)&&(e=JSON.parse(_fsExtra.default.readFileSync(a).toString()));var t={},o=_path.default.join(toolkitDir,"templates/app/demo/package.json");_fsExtra.default.existsSync(o)&&(t=JSON.parse(_fsExtra.default.readFileSync(o).toString()));for(var l in t){var r=t[l];"string"==typeof r&&e[l]?t[l]=e[l]:mergeProps(r,e[l])}_fsExtra.default.writeFileSync(a,JSON.stringify(t,null,2))}function copyFiles(e,a){var t=[];(0,_utils.traverseDirSync)(a,t),t.forEach(function(t){var o=_path.default.relative(a,t),l=_path.default.join(e,o);console.log(_chalk.default.green("file: ".concat(l," copied."))),_fsExtra.default.copySync(t,l)})}function upgradeSign(){console.log(_chalk.default.green("升级 签名文件"));var e=_path.default.join(curDir,"sign/debug");(0,_utils.clearDirSync)(e),(0,_utils.mkdirsSync)(e),copyFiles(e,_path.default.join(toolkitDir,"templates/app/demo/sign/debug"))}function upgradeEslint(){var e=_path.default.join(toolkitDir,"templates/app/demo",".eslintrc.json"),a=_path.default.join(curDir,".eslintrc.json");_fsExtra.default.copySync(e,a)}function upgradeBabelConfig(){var e=_path.default.join(toolkitDir,"templates/app/demo","babel.config.js"),a=_path.default.join(curDir,".babelrc"),t=_path.default.join(curDir,"babel.config.js"),o=(0,_utils.formatDate)("yyyyMMdd_hhmmss",new Date);if(console.log(_chalk.default.green("项目升级到babel7，默认配置使用babel.config.js")),_fsExtra.default.existsSync(a)){var l=_path.default.join(curDir,".babelrc.old."+o);_fsExtra.default.copySync(a,l),_fsExtra.default.removeSync(a),console.log(_chalk.default.yellow("### App Toolkit ### ".concat(".babelrc","的备份文件保存为: ").concat(l)))}if(_fsExtra.default.existsSync(t)){var r=_path.default.join(curDir,_path.default.basename("babel.config.js",".js")+".old."+o+".js");_fsExtra.default.copySync(t,r),console.log(_chalk.default.yellow("### App Toolkit ### 更新的".concat("babel.config.js","的备份文件保存为: ").concat(r)))}_fsExtra.default.existsSync(e)&&(_fsExtra.default.copySync(e,t),console.log(_chalk.default.yellow("### App Toolkit ### 更新的".concat("babel.config.js","成功！"))))}function savePackage(){var e="package.json",a=_path.default.join(curDir,e),t=(0,_utils.formatDate)("yyyyMMdd_hhmmss",new Date),o=_path.default.join(curDir,_path.default.basename(e,".json")+".old."+t+".json");_fsExtra.default.copySync(a,o),console.log(_chalk.default.yellow("### App Toolkit ### 更新的".concat(e,"的备份文件保存为: ").concat(o)))}function updateProject(e){var a=checkVersion();if(e)console.log(_chalk.default.yellow("强制升级工程( ".concat(a.cur," ----\x3e ").concat(a.toolkit," )(可能会出现兼容性问题)"))),savePackage(),upgradePackage();else{if(a.res<0||0===a.res&&!e)return void(0===a.res&&console.log("### App Toolkit ### 版本已经是最新版本"));console.log(_chalk.default.green("升级工程( ".concat(a.cur," ----\x3e ").concat(a.toolkit," )"))),upgradePackage()}upgradeSign(),upgradeEslint(),upgradeBabelConfig(),console.log(_chalk.default.green("升级完毕, 请运行npm install更新依赖包"))}var _path=_interopRequireDefault(require("path")),_fsExtra=_interopRequireDefault(require("fs-extra")),_chalk=_interopRequireDefault(require("chalk")),_semver=_interopRequireDefault(require("semver")),_utils=require("./utils"),curDir=process.cwd(),toolkitDir=_path.default.join(__dirname,"../");module.exports=updateProject;